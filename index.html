<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "5e5b2944-3dc5-4e01-941b-440c776aa4f8",
      safari_web_id: "web.onesignal.auto.67c39979-7446-4274-a748-fcdf2406257a",
      notifyButton: {
        enable: true,
      },
    });
  });
</script>
    <!-- FingerprintJS Library for device tracking -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <!-- [MODIFICATION - ADDED] OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        /* --- CSS Styles (No changes here) --- */
        :root {
            --primary-bg: #0F172A; /* Dark blue-gray */
            --secondary-bg: #1E293B; /* Slightly lighter blue-gray */
            --card-bg: #1E293B;
            --text-primary: #E2E8F0; /* Light gray for primary text */
            --text-secondary: #94A3B8; /* Muted gray for secondary text */
            --accent-color: #FACC15; /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue for primary actions */
            --border-color: #334155; /* Border color */
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981; /* Green for success */
            --danger-color: #EF4444; /* Red for danger/errors */
            --warning-color: #F59E0B; /* Orange for warnings */
            --info-color: #3B82F6; /* Blue for info */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); color: var(--text-primary); padding-top: 70px; padding-bottom: 75px; min-height: 100vh; overscroll-behavior-y: contain; }
        a { color: var(--accent-color); text-decoration: none; } a:hover { color: #FBBF24; }
        .main-content { padding: 15px; } .section { display: none; animation: fadeIn 0.3s ease-in-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); } .custom-card { background-color: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); } .btn-custom { border-radius: 6px; font-size: 0.9rem; font-weight: 500; padding: 8px 15px; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.2s ease, filter 0.2s ease; } .btn-custom-primary { background-color: var(--primary-button-bg); color: var(--text-primary); } .btn-custom-primary:hover { background-color: #2563EB; } .btn-custom-secondary { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .btn-custom-secondary:hover { background-color: #334155; } .btn-custom-accent { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .btn-custom-accent:hover { filter: brightness(1.1); } .btn-custom-link { background: none; border: none; color: var(--primary-button-bg); font-size: 0.9rem; font-weight: 500; padding: 0; cursor: pointer; } .text-accent { color: var(--accent-color); } .text-success { color: var(--success-color); } .text-danger { color: var(--danger-color); } .text-warning { color: var(--warning-color); } .form-control, .form-select { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; } .form-control:focus, .form-select:focus { background-color: var(--primary-bg); border-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); } .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; } .form-label { color: var(--text-secondary); font-size: 0.9rem; } .alert { border-radius: 6px; font-size: 0.9rem; } .list-group-item { background-color: var(--card-bg); color: var(--text-primary); border: none; border-bottom: 1px solid var(--border-color); padding: 15px; font-size: 0.95rem; transition: background-color 0.2s ease; } .list-group-item:hover { background-color: rgba(255, 255, 255, 0.05); } .list-group-item:last-child { border-bottom: none; } .list-group-item i:first-child { color: var(--accent-color); margin-right: 15px; font-size: 1.1rem; width: 20px; text-align: center; } .list-group-item .bi-chevron-right { color: var(--text-secondary); font-size: 0.9rem; } #globalLoaderEl { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; } .spinner-border { color: var(--accent-color); width: 3rem; height: 3rem; } .placeholder-glow .placeholder { background-color: rgba(51, 65, 85, 0.5); animation: placeholder-glow 2s ease-in-out infinite; } .placeholder { background-color: rgba(51, 65, 85, 0.5); border-radius: 4px; } @keyframes placeholder-glow { 0% { background-color: rgba(51, 65, 85, 0.5); } 50% { background-color: rgba(51, 65, 85, 0.7); } 100% { background-color: rgba(51, 65, 85, 0.5); } } .interactive-list-item { cursor: pointer; } .referral-code { font-family: monospace; letter-spacing: 1px; user-select: all; } .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-bottom: 1px solid var(--border-color); } .header-left { display: flex; align-items: center; gap: 10px; } .header-logo { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color); } .header-title { font-size: 0.9rem; font-weight: 500; line-height: 1.2; } .header-title span { font-size: 0.75rem; color: var(--text-secondary); display: block; } .header-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; margin-right: 5px; display: none; padding: 5px; } .header-right { display: flex; align-items: center; gap: 15px; } .notification-icon { font-size: 1.3rem; color: var(--text-primary); position: relative; background: none; border: none; padding: 0; } .notification-badge { position: absolute; top: -3px; right: -5px; background-color: var(--danger-color); color: white; font-size: 0.6rem; width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; } .wallet-chip { background: var(--accent-gradient); color: var(--primary-bg); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; font-size: 0.85rem; font-weight: 700; border: none; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); cursor: pointer; } .wallet-chip i { margin-right: 5px; font-size: 0.9rem; } .header-game-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 10px; display: none; } .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--bottom-nav-bg); display: flex; justify-content: space-around; align-items: stretch; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-top: 1px solid var(--border-color); } .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; flex-grow: 1; padding: 8px 0; transition: color 0.2s ease, background-color 0.2s ease; border: none; background: none; cursor: pointer; font-size: 0.7rem; } .nav-item i { font-size: 1.4rem; margin-bottom: 4px; line-height: 1; } .nav-item span { font-size: 0.7rem; font-weight: 500; line-height: 1; } .nav-item.active { color: var(--accent-color); background-color: rgba(250, 204, 21, 0.1); } .swiper-container#promotionSliderEl { width: 100%; height: 200px; border-radius: 10px; margin-bottom: 25px; --swiper-pagination-color: var(--accent-color); --swiper-pagination-bullet-inactive-color: var(--text-secondary); --swiper-pagination-bullet-size: 8px; } .swiper-slide { background-color: var(--secondary-bg); border-radius: 10px; } .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; } .game-card { text-align: center; background-color: var(--card-bg); border-radius: 8px; overflow: hidden; padding: 0; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s ease; } .game-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); } .game-card img { width: 100%; height: 130px; object-fit: cover; display: block; } .game-card span { display: block; padding: 10px 5px; font-weight: 500; font-size: 0.9rem; color: var(--text-primary); } .tournament-tabs { display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; } .tab-item { color: var(--text-secondary); background: none; border: none; padding: 8px 10px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; flex-grow: 1; text-align: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; } .tab-item.active { background-color: var(--primary-button-bg); color: var(--text-primary); } .tab-item i { margin-right: 5px; } .tournament-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); } .tournament-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; } .tournament-card-tags span { background-color: var(--primary-bg); color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; padding: 3px 8px; border-radius: 4px; display: inline-block; border: 1px solid var(--border-color); margin-right: 4px; margin-bottom: 4px; } .tournament-card-timer { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 4px; } .tournament-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); } .tournament-card-title i { color: var(--accent-color); } .tournament-card-info { display: flex; justify-content: space-between; align-items: stretch; border-top: 1px dashed var(--border-color); border-bottom: 1px dashed var(--border-color); padding: 10px 0; margin: 10px 0; font-size: 0.8rem; } .info-item { text-align: center; flex: 1; padding: 0 5px; } .info-item span { display: block; color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px; } .info-item strong { color: var(--text-primary); font-weight: 600; font-size: 0.9rem; } .info-item .prize-icon { color: var(--accent-color); font-size: 1.2rem; } .tournament-card-spots { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px; } .tournament-card-spots span { font-weight: 600; } .progress { height: 6px; background-color: var(--primary-bg); border-radius: 3px; overflow: hidden; } .progress-bar { background-color: var(--warning-color); transition: width 0.3s ease; } .tournament-card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; } .tournament-card-actions .btn-sm { padding: 8px 10px; font-size: 0.85rem; width: 100%; } .tournament-card-actions .btn-join { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; grid-column: 2 / 3; } .tournament-card-actions .btn-details { background-color: var(--secondary-bg); border: 1px solid var(--border-color); grid-column: 1 / 2; } .tournament-card-actions .btn-joined { background-color: var(--success-color); color: var(--text-primary); opacity: 0.8; grid-column: 2 / 3; } .tournament-card-actions .btn-disabled { background-color: var(--secondary-bg); opacity: 0.6; cursor: not-allowed; grid-column: 2 / 3; } .btn-idpass { background: var(--accent-gradient); color: var(--primary-bg); border: none; font-weight: 600; } .wallet-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color); } .wallet-card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 25px; } .balance-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); } .balance-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; } .balance-item-label { font-size: 0.95rem; color: var(--text-secondary); } .balance-item-value { font-size: 1.1rem; font-weight: 600; } .balance-item-action { min-width: 100px; text-align: right; } .balance-item-action .btn-custom-link { font-size: 0.85rem; color: var(--accent-color); padding: 5px; } .balance-item-action .btn-withdraw { background-color: var(--primary-button-bg); color: #fff; font-size: 0.8rem; padding: 5px 12px; border-radius: 5px; border: none; } #recentTransactionsListEl .custom-card { background-color: var(--secondary-bg); } #earnings-section .custom-card { text-align: center; } #earnings-section .display-4 { font-size: 3rem; } #earnings-section p strong { color: var(--text-primary); } .profile-header-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); } .profile-avatar { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--accent-color); object-fit: cover; background-color: var(--primary-bg); } .profile-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; } .profile-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px; word-break: break-all; } .profile-stats { display: flex; justify-content: space-around; width: 100%; border-top: 1px solid var(--border-color); padding-top: 15px; } .stat-item { text-align: center; flex: 1; } .stat-item strong { display: block; font-size: 1rem; font-weight: 600; } .stat-item span { font-size: 0.75rem; color: var(--text-secondary); } .profile-links .list-group { border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); } .profile-links .form-switch .form-check-input { background-color: var(--secondary-bg); border-color: var(--border-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e"); } .profile-links .form-switch .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); } #login-section { margin-top: 5vh; } #login-section .card { background-color: var(--card-bg); border: 1px solid var(--border-color); } #login-section .btn-primary { background-color: var(--primary-button-bg); border: none; } #login-section .btn-link { background: none; border: none; color: var(--accent-color); text-decoration: none; font-size: 0.9em; padding: 5px 0; } #login-section .btn-link:hover { text-decoration: underline; } #login-section .btn-success { background-color: var(--success-color); border: none; } #login-section .btn-danger { background-color: var(--danger-color); border: none; } #login-section .form-divider { text-align: center; margin: 20px 0; position: relative; color: var(--text-secondary); } #login-section .form-divider::before, #login-section .form-divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background-color: var(--border-color); } #login-section .form-divider::before { left: 0; } #login-section .form-divider::after { right: 0; } #login-section .form-divider span { background-color: var(--card-bg); padding: 0 10px; position: relative; z-index: 1; font-size: 0.8rem; font-weight: 500; } #login-section .card-title { color: var(--text-primary); } #googleSignInBtnMainEl { display: none; } .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .modal-header { border-bottom-color: var(--border-color); } .modal-footer { border-top-color: var(--border-color); } .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } .modal-body .phonepe-number { color: var(--warning-color); font-weight: bold; user-select: text; } #matchDetailsModalBodyEl pre { background-color: var(--primary-bg); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; } #policyModalBodyEl { line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; } #idPasswordModalEl .copy-btn { padding: 2px 6px; font-size: 0.8rem; margin-left: 8px; vertical-align: middle; } #policyModalBodyEl .copy-btn, #policyModalBodyEl #shareReferralBtn { padding: 4px 10px; font-size: 0.9rem; } #policyModalBodyEl #shareReferralBtn i, #policyModalBodyEl .copy-btn i { margin-right: 5px; } #securityWarning { background-color: var(--danger-color); color: white; padding: 10px 15px; text-align: center; font-size: 0.9rem; position: sticky; top: 60px; z-index: 999; border-bottom: 1px solid #a51d1d; } #securityWarning a { color: #ffdddd; text-decoration: underline; } #securityWarning button { background: none; border: 1px solid white; color: white; padding: 2px 8px; margin-left: 15px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }
        .results-table { width: 100%; font-size: 0.9rem; border-collapse: collapse; }
        .results-table th, .results-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .results-table th { font-weight: 600; color: var(--text-secondary); }
        .results-table .rank { font-weight: 700; width: 50px; text-align: center;}
        .results-table .player-name { font-weight: 500; }
        .results-table .kills, .results-table .winnings { text-align: center; }
        .results-table .winnings { color: var(--success-color); font-weight: 600; }
        .results-table tr.current-user-row { background-color: rgba(250, 204, 21, 0.15); border-left: 3px solid var(--accent-color); }
        .results-table tr:last-child td { border-bottom: none; }
        .whatsapp-flot { position: fixed; width: 60px; height: 60px; bottom: 80px; right: 15px; background-color: #25d366; color: #FFF; border-radius: 50px; text-align: center; font-size: 30px; box-shadow: 2px 2px 3px rgba(0,0,0,0.2); z-index: 1001; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: filter 0.2s ease; }
        .whatsapp-flot:hover { color: #FFF; filter: brightness(1.1); }
        .challenge-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 12px; }
        .challenge-card-header { display: flex; align-items: center; justify-content: space-between; }
        .challenge-card-header .player-info { display: flex; align-items: center; gap: 10px; }
        .challenge-card-header .player-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background-color: var(--primary-bg); }
        .challenge-card-header .player-name { font-weight: 600; font-size: 0.95rem; }
        .challenge-card-stake { font-size: 1.2rem; font-weight: 700; color: var(--accent-color); }
        .challenge-card-body { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .challenge-card-body .game-name { font-weight: 500; }
        .challenge-card-status { font-size: 0.8rem; font-weight: 600; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; }
        .status-open { background-color: var(--success-color); color: var(--text-primary); }
        .status-active { background-color: var(--info-color); color: var(--text-primary); }
        .status-completed { background-color: var(--secondary-bg); color: var(--text-secondary); }
        .status-disputed { background-color: var(--danger-color); color: var(--text-primary); }
        .challenge-card-actions { margin-top: 5px; }
        .vs-icon { font-size: 1.5rem; color: var(--text-secondary); margin: 0 10px; }
        .challenge-result-form .btn { flex: 1; }
        #challenge-rules { font-size: 0.85rem; line-height: 1.5; background-color: var(--primary-bg); padding: 10px; border-radius: 6px; margin-top: 15px; border: 1px dashed var(--border-color); display:none;}
    </style>
</head>

<body>
     <div id="securityWarning" style="display: none;"><i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are insecure (public). Anyone can read/write data.<a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to secure rules.</a><button onclick="this.parentElement.style.display='none'">Dismiss</button></div>
    <header class="app-header"><div class="header-left"><button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button><img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo" id="appLogoEl"><div class="header-title" id="headerTitleContainerEl"> Welcome <span id="headerUserGreetingEl">Guest</span> </div><div class="header-game-title" id="headerGameTitleEl">Game Title</div></div><div class="header-right"><button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button><button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i class="bi bi-wallet-fill"></i> <span id="headerChipBalanceEl">0</span> </button></div></header>
    <main class="main-content"><div id="globalLoaderEl"> <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> </div>
        <section id="login-section" class="section"><div class="container" style="max-width: 450px;"><div class="card shadow-sm custom-card"><div class="card-body p-4"><form id="emailLoginForm"><h2 class="card-title text-center mb-4">Login</h2><div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="name@example.com" required> </div><div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required> </div><div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div><div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div></form><form id="emailSignupForm" style="display: none;"><h2 class="card-title text-center mb-4">Sign Up</h2><div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="name@example.com" required> </div><div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div><div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label> <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div><div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div><div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div><div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have account? Login</button> </div></form></div></div></div></section>
        <section id="home-section" class="section"><div class="swiper-container" id="promotionSliderEl"><div class="swiper-wrapper placeholder-glow"><div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div></div><div class="swiper-pagination"></div></div><h2 class="section-title">Esport Games</h2><div class="row g-3 mb-4 placeholder-glow" id="gamesListEl"><div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div> <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div></div><h2 class="section-title">My Contests</h2><div id="myContestsListEl" class="placeholder-glow"><div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div><p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p></div></section>
        <section id="tournaments-section" class="section"><div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div><div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div><p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p></section>
        <section id="challenges-section" class="section"><div class="d-flex justify-content-between align-items-center mb-3"><h2 class="section-title mb-0">1v1 Challenges</h2><button class="btn btn-custom btn-custom-accent btn-sm" id="createChallengeBtnEl"><i class="bi bi-plus-circle-fill"></i> Create</button></div><div class="tournament-tabs"><button class="tab-item active" data-filter="open"><i class="bi bi-unlock-fill"></i> Open</button><button class="tab-item" data-filter="my"><i class="bi bi-person-video3"></i> My Challenges</button></div><div id="challengesListContainerEl" class="mt-3 placeholder-glow"><div class="challenge-card placeholder-glow mb-3"><span class="placeholder col-12" style="height: 40px;"></span><span class="placeholder col-12" style="height: 24px;"></span><span class="placeholder col-8" style="height: 16px;"></span><span class="placeholder col-4 ms-auto" style="height: 30px; border-radius: 6px;"></span></div></div><p id="noChallengesMessageEl" class="text-secondary text-center mt-4" style="display: none;">No challenges found.</p></section>
        <section id="wallet-section" class="section"><div class="wallet-card custom-card"><h2 class="section-title mb-4">Wallet</h2><div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div> </div><div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-withdraw" id="withdrawBtnEl">Withdraw</button> </div> </div><div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action" style="min-width: 100px;"></div> </div><button class="btn btn-custom btn-custom-secondary w-100 mt-4" id="addAmountWalletBtnEl"> <i class="bi bi-plus-circle-fill me-2"></i>Add Amount </button></div><h3 class="section-title mt-4">Recent Transactions</h3><div id="recentTransactionsListEl" class="placeholder-glow"> <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div> <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> </div></section>
        <section id="earnings-section" class="section"><h2 class="section-title">Earnings</h2><div class="custom-card text-center"><i class="bi bi-coin display-4 text-accent mb-3"></i><p class="text-secondary mb-4">Track your earnings from tournaments and referrals here.</p><div class="placeholder-glow"> <p>Total Earned: <strong id="earningsTotalEl"><span class="placeholder col-3"></span></strong></p> <p>From Referrals: <strong id="earningsReferralEl"><span class="placeholder col-3"></span></strong></p> </div><button class="btn btn-custom btn-custom-link mt-3" id="viewEarningsHistoryBtn">View History</button></div></section>
        <section id="profile-section" class="section"><div class="profile-header-card placeholder-glow"> <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl"> <h3 class="profile-name mt-2" id="profileNameEl"><span class="placeholder col-6"></span></h3> <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p> <div class="profile-stats w-100"> <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div> <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div> <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div> </div> </div><div class="profile-links"><div class="list-group custom-card"><label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"> <span><i class="bi bi-bell-fill"></i> Notifications</span> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked> </div> </label><a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i class="bi bi-chevron-right"></i> </a><a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i class="bi bi-chevron-right"></i> </a><a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i class="bi bi-chevron-right"></i> </a><a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i class="bi bi-chevron-right"></i> </a><a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i class="bi bi-chevron-right"></i> </a><button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span> </button></div></div></section>
    </main>
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    
    <div class="modal fade" id="addAmountModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle-fill me-2"></i> Add Amount Request</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary"><strong>Step 1:</strong> Pay the desired amount using any UPI app to the ID below.</p><p class="text-center"><strong>UPI ID:</strong> <span class="phonepe-number" id="upiIdDisplayEl" style="user-select: all;">Loading...</span><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#upiIdDisplayEl" title="Copy UPI ID"><i class="bi bi-clipboard"></i></button></p><hr style="border-color: var(--border-color);"><p class="small text-secondary"><strong>Step 2:</strong> After payment, fill the form below and submit your request.</p><form id="addMoneyRequestForm"><div class="mb-3"><label for="addAmountInputEl" class="form-label">Amount Sent ()</label><input type="number" class="form-control" id="addAmountInputEl" placeholder="e.g., 100" required></div><div class="mb-3"><label for="transactionIdInputEl" class="form-label">Transaction ID / UTR</label><input type="text" class="form-control" id="transactionIdInputEl" placeholder="Enter payment reference number" required></div><div id="addMoneyStatusMessageEl" class="alert mt-3" style="display: none;"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitAddMoneyRequestBtnEl">Submit Request</button></div></div></div></div>

    <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">0.00</strong></p><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min <span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method (UPI/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter UPI ID / Bank Details"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div>
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Room ID & Password</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-secondary">ID/Pass shown shortly before match start.</p><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Room ID:</p><h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Password:</p><h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div><p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p></div></div></div></div>
    <div class="modal fade" id="gameIdModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Enter Your Game Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Please provide your Free Fire username and UID to join the tournament. This is required for verification and prize distribution.</p><p class="small mb-3">Joining: <strong id="gameIdModalTournamentNameEl">Tournament Name</strong><br>Fee: <strong id="gameIdModalEntryFeeEl">0</strong></p><form id="gameIdForm"><div class="mb-3"><label for="gameUsernameInputEl" class="form-label">In-Game Name (IGN)</label><input type="text" class="form-control" id="gameUsernameInputEl" placeholder="Your Free Fire Name" required></div><div class="mb-3"><label for="gameUidInputEl" class="form-label">Game UID</label><input type="text" class="form-control" id="gameUidInputEl" placeholder="Your Free Fire User ID" required></div><div id="gameIdStatusMessageEl" class="alert mt-3" style="display: none;"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-accent" id="confirmJoinBtnEl">Confirm & Join</button></div></div></div></div>
    
    <div class="modal fade" id="createChallengeModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Create New Challenge</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p class="small text-secondary">You can only have one active challenge at a time. The prize will have a 5% admin commission.</p>
                    <form id="createChallengeForm">
                        <div class="mb-3">
                            <label for="challengeGameModeSelectEl" class="form-label">Game / Mode</label>
                            <select class="form-select" id="challengeGameModeSelectEl" required>
                                <option value="" selected disabled>-- Select a Game Mode --</option>
                                <option value="Ludo King Classic">Ludo King Classic</option>
                                <option value="Snake & Ladders">Snake & Ladders</option>
                                <option value="FF Lone Wolf">FF Lone Wolf</option>
                                <option value="FF Clash Squad">FF Clash Squad</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="challengeAmountInputEl" class="form-label">Challenge Amount ()</label>
                            <input type="number" class="form-control" id="challengeAmountInputEl" placeholder="e.g., 50" required min="10">
                        </div>
                        <div class="mb-3">
                            <label for="challengeCustomRulesInputEl" class="form-label">Custom Rules (Optional)</label>
                            <textarea class="form-control" id="challengeCustomRulesInputEl" rows="3" placeholder="e.g., No sniping, pistols only..."></textarea>
                        </div>
                        <div id="challenge-rules"></div>
                        <div id="createChallengeStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-accent" id="submitChallengeBtnEl">Create Challenge</button></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="viewChallengeModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="viewChallengeModalTitleEl">Challenge Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="viewChallengeModalBodyEl"></div></div></div></div>

    <div class="modal fade" id="reportResultModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportResultModalTitleEl">Report Result</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reportResultFormEl">
                        <input type="hidden" id="reportChallengeIdInputEl">
                        <input type="hidden" id="reportTypeInputEl">
                        
                        <div class="mb-3" id="reportScreenshotContainerEl">
                            <label for="reportScreenshotInputEl" class="form-label">Screenshot Proof</label>
                            <input type="file" class="form-control" id="reportScreenshotInputEl" accept="image/*" required>
                            <img id="reportImagePreviewEl" src="" class="img-fluid rounded mt-2" style="display:none; max-height: 200px;">
                        </div>

                        <div class="mb-3" id="reportMessageContainerEl" style="display: none;">
                            <label for="reportMessageInputEl" class="form-label">Message / Reason</label>
                            <textarea class="form-control" id="reportMessageInputEl" rows="3" placeholder="Explain the issue..."></textarea>
                        </div>

                        <div id="reportResultStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-accent" id="submitReportBtnEl">Submit Report</button>
                </div>
            </div>
        </div>
    </div>
    
    <a href="#" id="whatsappFlotIconEl" class="whatsapp-flot" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-whatsapp"></i></a>
    
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="challenges-section"><i class="bi bi-controller"></i><span>Challenges</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // --- OneSignal Configuration ---
        // IMPORTANT: Replace these with your actual OneSignal keys.
        const ONE_SIGNAL_APP_ID = "5e5b2944-3dc5-4e01-941b-440c776aa4f8";
        // SECURITY WARNING: Exposing the REST API Key on the client-side is a major security risk.
        // In a production environment, all notification sending logic should be handled by a secure backend server (e.g., Firebase Cloud Functions).
        // This is included here to fulfill the request within the constraints of a single client-side file.
        const ONE_SIGNAL_REST_API_KEY = "os_v2_app_lznssrb5yvhadfa3iqgho2ve7dzkceb4a7re6jmojzlpm4zkj6maiei76pdzcwqy3c6vlyv7mrsbd6nag3l3xdr2czzcrhqhfhwnm2a";


        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyC9Hou8cKrUZ00pjrbog_ccjwEZq8wJQpI",
          authDomain: "ludo-55ffb.firebaseapp.com",
          databaseURL: "https://ludo-55ffb-default-rtdb.firebaseio.com",
          projectId: "ludo-55ffb",
          storageBucket: "ludo-55ffb.firebasestorage.app",
          messagingSenderId: "626385206901",
          appId: "1:626385206901:web:fd1b213ffe97944a8ec23c",
          measurementId: "G-GPJ15HMSQC"
        };
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5">Critical Error: Could not connect. Check Firebase config.</div>`;
        }

         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
             loginSection: getElement('login-section'), emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             emailSignupForm: getElement('emailSignupForm'), signupEmailInput: getElement('signupEmailInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'),
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('#tournaments-section .tournament-tabs .tab-item'),
             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             earningsSection: getElement('earnings-section'), earningsTotal: getElement('earningsTotalEl'), earningsReferral: getElement('earningsReferralEl'), viewEarningsHistoryBtn: getElement('viewEarningsHistoryBtn'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, upiIdDisplay: getElement('upiIdDisplayEl'), addAmountInput: getElement('addAmountInputEl'), transactionIdInput: getElement('transactionIdInputEl'), addMoneyStatusMessage: getElement('addMoneyStatusMessageEl'), submitAddMoneyRequestBtn: getElement('submitAddMoneyRequestBtnEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             gameIdModalInstance: getElement('gameIdModalEl') ? new bootstrap.Modal(getElement('gameIdModalEl')) : null, gameIdModalTournamentName: getElement('gameIdModalTournamentNameEl'), gameIdModalEntryFee: getElement('gameIdModalEntryFeeEl'), gameUsernameInput: getElement('gameUsernameInputEl'), gameUidInput: getElement('gameUidInputEl'), gameIdStatusMessage: getElement('gameIdStatusMessageEl'), confirmJoinBtn: getElement('confirmJoinBtnEl'),
             challengesSection: getElement('challenges-section'),
             createChallengeBtn: getElement('createChallengeBtnEl'),
             challengeTabs: querySelAll('#challenges-section .tournament-tabs .tab-item'),
             challengesListContainer: getElement('challengesListContainerEl'),
             noChallengesMessage: getElement('noChallengesMessageEl'),
             createChallengeModalInstance: getElement('createChallengeModalEl') ? new bootstrap.Modal(getElement('createChallengeModalEl')) : null,
             challengeGameModeSelect: getElement('challengeGameModeSelectEl'),
             challengeAmountInput: getElement('challengeAmountInputEl'),
             challengeCustomRulesInput: getElement('challengeCustomRulesInputEl'), 
             challengeRules: getElement('challenge-rules'),
             createChallengeStatusMessage: getElement('createChallengeStatusMessageEl'),
             submitChallengeBtn: getElement('submitChallengeBtnEl'),
             viewChallengeModalInstance: getElement('viewChallengeModalEl') ? new bootstrap.Modal(getElement('viewChallengeModalEl')) : null,
             viewChallengeModalTitle: getElement('viewChallengeModalTitleEl'),
             viewChallengeModalBody: getElement('viewChallengeModalBodyEl'),
             reportResultModalInstance: getElement('reportResultModalEl') ? new bootstrap.Modal(getElement('reportResultModalEl')) : null,
             reportResultModalTitle: getElement('reportResultModalTitleEl'), 
             reportResultForm: getElement('reportResultFormEl'), 
             reportChallengeIdInput: getElement('reportChallengeIdInputEl'), 
             reportTypeInput: getElement('reportTypeInputEl'),
             reportScreenshotContainer: getElement('reportScreenshotContainerEl'),
             reportScreenshotInput: getElement('reportScreenshotInputEl'),
             reportImagePreview: getElement('reportImagePreviewEl'),
             reportMessageContainer: getElement('reportMessageContainerEl'),
             reportMessageInput: getElement('reportMessageInputEl'),
             reportResultStatusMessage: getElement('reportResultStatusMessageEl'),
             submitReportBtn: getElement('submitReportBtnEl'),
             securityWarning: getElement('securityWarning'),
             whatsappFlotIcon: getElement('whatsappFlotIconEl')
         };

        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let validReferrerUid = null;
        let pendingFingerprint = null; 

        // --- OneSignal Functions ---
        async function initializeOneSignal(userId) {
            if (ONE_SIGNAL_APP_ID === "YOUR_ONESIGNAL_APP_ID") {
                console.warn("OneSignal APP ID is not configured. Notifications will not work.");
                return;
            }
            // Wait for the SDK to be available
            window.OneSignal = window.OneSignal || [];
            await window.OneSignal.push(async () => {
                await window.OneSignal.init({
                    appId: ONE_SIGNAL_APP_ID,
                    allowLocalhostAsSecureOrigin: true,
                });
                
                // Set external_user_id to link device with Firebase user
                await window.OneSignal.login(userId);

                // Handle subscription changes
                window.OneSignal.on('subscriptionChange', async (isSubscribed) => {
                    const currentUid = auth.currentUser?.uid;
                    if (!currentUid) return;

                    const userRef = ref(db, `users/${currentUid}`);
                    if (isSubscribed) {
                        const playerId = await window.OneSignal.getUserId();
                        if (playerId) {
                            await update(userRef, { oneSignalPlayerId: playerId });
                            console.log("OneSignal Player ID saved:", playerId);
                        }
                    } else {
                        await update(userRef, { oneSignalPlayerId: null });
                        console.log("OneSignal Player ID removed as user unsubscribed.");
                    }
                });

                // Update notification switch based on permission
                const permission = await window.OneSignal.getNotificationPermission();
                if(elements.notificationSwitch) elements.notificationSwitch.checked = (permission === 'granted');

            });
        }
        
        async function _sendNotificationViaApi(playerIds, heading, content, data = {}) {
            if (ONE_SIGNAL_REST_API_KEY === "YOUR_ONESIGNAL_REST_API_KEY" || playerIds.length === 0) {
                console.log("Skipping notification: Not configured or no recipients.", {playerIds, heading, content});
                return;
            }
            const message = {
                app_id: ONE_SIGNAL_APP_ID,
                include_player_ids: playerIds,
                headings: { en: heading },
                contents: { en: content },
                data: data
            };
            try {
                await fetch('https://onesignal.com/api/v1/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Basic ${ONE_SIGNAL_REST_API_KEY}`
                    },
                    body: JSON.stringify(message)
                });
                console.log("Notification sent successfully to:", playerIds);
            } catch (error) {
                console.error("Error sending OneSignal notification:", error);
            }
        }

        async function sendNotificationToUser(targetUid, heading, content) {
            if (!targetUid) return;
            try {
                const userSnap = await get(ref(db, `users/${targetUid}`));
                if (userSnap.exists() && userSnap.val().oneSignalPlayerId) {
                    const playerId = userSnap.val().oneSignalPlayerId;
                    await _sendNotificationViaApi([playerId], heading, content);
                } else {
                    console.log(`User ${targetUid} has no Player ID, cannot send notification.`);
                }
            } catch (error) {
                console.error(`Failed to get player ID for user ${targetUid}`, error);
            }
        }


        // --- Core App Functions (Unchanged logic, just integrating new calls) ---
        const showLoader = (show) => { if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none'; };
        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type} mt-3`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        function copyToClipboard(targetSelector) { if (!targetSelector) { alert('Copy target not defined.'); return; } const targetElement = querySel(targetSelector); if (!targetElement) { alert('Element to copy from not found.'); return; } const textToCopy = targetElement.textContent; if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder') || textToCopy.includes('Loading...')) { alert('Nothing to copy.'); return; } navigator.clipboard.writeText(textToCopy).then(() => alert('Copied!')).catch(err => { console.error('Failed to copy:', err); alert('Failed to copy.'); }); }
        
        function shareReferral(code) { if (!code || code === 'N/A') { alert('Referral code not available.'); return; } const shareText = `Join me on Toxic Fire Tournament! Use my referral code *${code}*  Play  Refer  Earn  Register with Referral Code.  Earn 10 per referral Download the app here: ${window.location.origin}`; const shareData = { title: 'Join Me on Toxic Fire Tournament!', text: ` Play  Refer  Earn\n Register with Referral Code: ${code} &  Earn 10 per referral\n Join the hottest gaming tournament platform App: ${window.location.origin}` }; if (navigator.share) { navigator.share(shareData).then(() => console.log('Successful share')).catch((error) => console.log('Error sharing:', error)); } else { const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`; window.open(whatsappUrl, '_blank'); } }

        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting Soon'; const days = Math.floor(diff / 86400000); const hours = Math.floor((diff % 86400000) / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };
        const getAvatar = (profile) => profile?.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.displayName || 'P')}&background=1E293B&color=E2E8F0&bold=true&size=40`;

        async function uploadToImgBB(file) { const apiKey = '889681763fb9ce32babda510f5fb857a'; if (!apiKey) { alert('ImgBB API key is not configured.'); throw new Error('ImgBB API key missing.'); } const formData = new FormData(); formData.append('image', file); try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData, }); const result = await response.json(); if (result.success) { return result.data.display_url; } else { throw new Error(result.error?.message || 'Failed to upload image to ImgBB.'); } } catch (error) { console.error('ImgBB Upload Error:', error); throw error; } }

        function showSection(sectionId) { if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; } const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; } const protectedSections = ['home-section', 'wallet-section', 'earnings-section', 'profile-section', 'tournaments-section', 'challenges-section']; const isLoggedIn = !!currentUser; if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; } if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; } elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId; updateHeaderForSection(sectionId); elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId)); console.log(`Loading data for section: ${sectionId}`); switch (sectionId) { case 'home-section': loadHomePageData(); break; case 'wallet-section': loadWalletData(); break; case 'profile-section': loadProfileData(); break; case 'earnings-section': loadEarningsData(); break; case 'tournaments-section': if(currentTournamentGameId) { const activeTab = querySel('#tournaments-section .tournament-tabs .tab-item.active')?.dataset.status || 'upcoming'; filterTournaments(currentTournamentGameId, activeTab); } else { elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>'; } break; case 'challenges-section': const activeChallengeFilter = querySel('#challenges-section .tournament-tabs .tab-item.active')?.dataset.filter || 'open'; loadChallenges(activeChallengeFilter); break; } if (sectionId === 'login-section') { toggleLoginForm(true); } window.scrollTo(0, 0); }
        function updateHeaderForSection(sectionId) { const showBackButton = (sectionId === 'tournaments-section'); const defaultTitleVisible = !showBackButton; const gameTitleVisible = showBackButton; if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none'; if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none'; if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none'; if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) { const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`; elements.headerGameTitle.textContent = gameName; } else if (defaultTitleVisible && elements.headerUserGreeting) { const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; elements.headerUserGreeting.textContent = nameToShow; } }
        function updateGlobalUI(isLoggedIn) { if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; } if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest'; if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0'; elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none'; }); const earningsNav = document.querySelector('.nav-item[data-section="earnings-section"]'); if(earningsNav) earningsNav.style.display = 'none'; }
        function populateUserInfo(user, profile) { if (!user || !profile) return; const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User'; const photoURL = getAvatar(profile); const winningCash = (profile.winningCash || 0); const bonusCash = (profile.bonusCash || 0); const totalBalance = winningCash + bonusCash; const totalEarnings = (profile.totalEarnings || 0); const referralEarnings = (profile.referralEarnings || 0); const totalMatches = profile.totalMatches || 0; const wonMatches = profile.wonMatches || 0; const formatCurrency = (amount) => `${amount.toFixed(2)}`; if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0]; if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(totalBalance); if (elements.walletTotalBalance) { elements.walletTotalBalance.textContent = formatCurrency(totalBalance); removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow')); } if (elements.walletWinningCash) { elements.walletWinningCash.textContent = formatCurrency(winningCash); removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow')); } if (elements.walletBonusCash) { elements.walletBonusCash.textContent = formatCurrency(bonusCash); removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow')); } if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash); if (elements.profileAvatar) elements.profileAvatar.src = photoURL; if (elements.profileName) { elements.profileName.textContent = displayName; removePlaceholders(elements.profileName.closest('.placeholder-glow')); } if (elements.profileEmail) { elements.profileEmail.textContent = user.email || 'N/A'; removePlaceholders(elements.profileEmail.closest('.placeholder-glow')); } if (elements.profileTotalMatches) { elements.profileTotalMatches.textContent = totalMatches; removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow')); } if (elements.profileWonMatches) { elements.profileWonMatches.textContent = wonMatches; removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow')); } if (elements.profileTotalEarnings) { elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow')); } if (elements.earningsTotal) { elements.earningsTotal.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.earningsTotal.closest('.placeholder-glow')); } if (elements.earningsReferral) { elements.earningsReferral.textContent = formatCurrency(referralEarnings); removePlaceholders(elements.earningsReferral.closest('.placeholder-glow')); } }
        function toggleLoginForm(showLogin) { if (!elements.emailLoginForm || !elements.emailSignupForm) return; clearStatusMessage(elements.loginStatusMessage); clearStatusMessage(elements.signupStatusMessage); elements.emailLoginForm.style.display = showLogin ? 'block' : 'none'; elements.emailSignupForm.style.display = showLogin ? 'none' : 'block'; elements.emailLoginForm.reset(); elements.emailSignupForm.reset(); }
        
        async function signUpWithEmail() {
            if (!auth) return;
            const em = elements.signupEmailInput.value.trim();
            const pw = elements.signupPasswordInput.value;
            const cpw = elements.signupConfirmPasswordInput.value;
            const refCode = elements.signupReferralCodeInput.value.trim();
            if (!em || !pw || !cpw) { showStatusMessage(elements.signupStatusMessage, 'Fill required fields.', 'warning'); return; }
            if (pw !== cpw) { showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning'); return; }
            if (pw.length < 6) { showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning'); return; }
            showLoader(true);
            clearStatusMessage(elements.signupStatusMessage);
            validReferrerUid = null;
            pendingFingerprint = null;
            
            try {
                // Step 1: Check device fingerprint
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                const visitorId = result.visitorId;
                
                const fingerprintRef = ref(db, `deviceFingerprints/${visitorId}`);
                const fingerprintSnap = await get(fingerprintRef);

                if (fingerprintSnap.exists()) {
                    throw new Error("An account has already been created on this device.");
                }
                
                // If fingerprint is new, store it temporarily
                pendingFingerprint = visitorId;

                // Step 2: Check referral code (if provided)
                if (refCode) {
                    const usersRef = ref(db, 'users');
                    const snapshot = await get(query(usersRef, orderByChild('referralCode'), equalTo(refCode)));
                    if (snapshot.exists()) {
                        const [uid] = Object.keys(snapshot.val());
                        validReferrerUid = uid;
                    }
                }
                
                // Step 3: Create user
                await createUserWithEmailAndPassword(auth, em, pw);
            } catch (e) {
                console.error("Signup Error:", e);
                let m = `Signup failed.`;
                if (e.message.includes("already been created on this device")) {
                    m = e.message;
                } else {
                    switch (e.code) {
                        case 'auth/email-already-in-use': m = 'Email already registered.'; break;
                        case 'auth/weak-password': m = 'Password too weak.'; break;
                        case 'auth/invalid-email': m = 'Invalid email.'; break;
                        case 'auth/network-request-failed': m = 'Network error.'; break;
                        default: m = `Error: ${e.message}`;
                    }
                }
                showStatusMessage(elements.signupStatusMessage, m, 'danger');
            } finally {
                showLoader(false);
            }
        }
        
        async function loginWithEmail() { if (!auth) return; const em = elements.loginEmailInput.value.trim(); const pw = elements.loginPasswordInput.value; if (!em || !pw) { showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning'); return; } showLoader(true); clearStatusMessage(elements.loginStatusMessage); try { await signInWithEmailAndPassword(auth, em, pw); } catch (e) { console.error("Login Error:", e); let m = `Login failed.`; switch (e.code) { case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password.'; break; case 'auth/invalid-email': m = 'Invalid email format.'; break; case 'auth/too-many-requests': m = 'Too many attempts. Reset pass or wait.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; case 'auth/user-disabled': m = 'Account disabled.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); } finally { showLoader(false); } }
        
        async function resetPassword() {
            if (!auth) return;
            let em = elements.loginEmailInput.value.trim();
            if (!em) {
                em = prompt("Please enter the email address for your account to reset the password:");
                if (!em) {
                    return; 
                }
            }
            showLoader(true);
            clearStatusMessage(elements.loginStatusMessage);
            try {
                await sendPasswordResetEmail(auth, em);
                showStatusMessage(elements.loginStatusMessage, `Password reset email sent to <b>${em}</b>! Check your inbox/spam folder.`, 'success', false);
            } catch (e) {
                console.error("Reset Pass Error:", e);
                let m = `Failed to send email.`;
                switch (e.code) {
                    case 'auth/user-not-found':
                    case 'auth/invalid-email':
                        m = 'No account found with that email address.';
                        break;
                    case 'auth/network-request-failed':
                        m = 'Network error. Please check your connection and try again.';
                        break;
                    default:
                        m = `Error: ${e.message}`;
                }
                showStatusMessage(elements.loginStatusMessage, m, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function logoutUser() { 
            if (!auth) return; 
            try { 
                showLoader(true); 
                // [MODIFICATION] - Logout from OneSignal
                if (window.OneSignal) {
                    await window.OneSignal.logout();
                    console.log("OneSignal user logged out.");
                }
                await signOut(auth); 
            } catch (e) { 
                console.error("Sign Out Error:", e); 
                alert(`Logout failed: ${e.message}`); 
                showLoader(false); 
            } 
        }

        async function handleAuthStateChange(user) {
            if (!auth || !db) { console.error("Firebase not ready in auth change"); showLoader(false); return; }
            showLoader(true);
            detachAllDbListeners();
            currentUser = user;
            const localReferrerUid = validReferrerUid;
            validReferrerUid = null;
            const localFingerprint = pendingFingerprint;
            pendingFingerprint = null;

            if (user) {
                console.log("Auth State: Logged In", user.uid);
                // [MODIFICATION] - Initialize OneSignal
                initializeOneSignal(user.uid);

                const userRef = ref(db, 'users/' + user.uid);
                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) { // Existing user
                        userProfile = snapshot.val();
                    } else { // New user
                        console.log("New user, creating profile...");
                        
                        // Link fingerprint to this new user UID
                        if (localFingerprint) {
                            const fingerprintRef = ref(db, `deviceFingerprints/${localFingerprint}`);
                            await set(fingerprintRef, { userId: user.uid, createdAt: serverTimestamp() });
                        }
                        
                        // [MODIFICATION] - Add oneSignalPlayerId field to new user profile
                        const newUserProfile = { uid: user.uid, displayName: user.displayName || user.email?.split('@')[0] || 'User', email: user.email || null, photoURL: user.photoURL || null, winningCash: 0, bonusCash: appSettings.newUserBonus || 0, totalMatches: 0, wonMatches: 0, totalEarnings: 0, referralEarnings: 0, createdAt: serverTimestamp(), referralCode: generateReferralCode(), joinedTournaments: {}, gameProfiles: {}, isAdmin: false, oneSignalPlayerId: null, ...(localReferrerUid && { referredBy: localReferrerUid }) };
                        await set(userRef, newUserProfile);
                        userProfile = newUserProfile;
                        if (newUserProfile.bonusCash > 0) { await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`); }
                        if (localReferrerUid && appSettings.referralBonus > 0) {
                            console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${localReferrerUid}`);
                            const referrerRef = ref(db, `users/${localReferrerUid}`);
                            try {
                                const referrerUpdateResult = await runTransaction(referrerRef, (referrerData) => { if (referrerData) { referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus; referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus; } return referrerData; });
                                if (referrerUpdateResult.committed) { await recordTransaction(localReferrerUid, 'referral_bonus', appSettings.referralBonus, `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`); console.log("Referrer bonus awarded successfully."); } else { console.error("Referrer bonus transaction aborted."); }
                            } catch (referrerError) { console.error("Error awarding referrer bonus:", referrerError); }
                        }
                    }
                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);
                    const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                    showSection(targetSection);
                } catch (error) {
                    console.error("Profile handling error:", error);
                    alert("Error loading profile. Logging out. " + error.message);
                    try { await logoutUser(); } catch (logoutErr) {}
                }
            } else {
                console.log("Auth State: Logged Out");
                currentUser = null;
                userProfile = {};
                updateGlobalUI(false);
                showSection('login-section');
            }
            showLoader(false);
        }

        async function loadAppSettings() {
            console.log("Loading App Settings...");
            try {
                const settingsRef = ref(db, 'settings');
                const snapshot = await get(settingsRef);
                if (snapshot.exists()) {
                    appSettings = snapshot.val() || {};
                    console.log("App Settings Loaded:", appSettings);
                    if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl;
                    if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw;
                    
                    if (appSettings.whatsappContact && elements.whatsappFlotIcon) {
                        elements.whatsappFlotIcon.href = `https://wa.me/${appSettings.whatsappContact}`;
                        elements.whatsappFlotIcon.style.display = 'flex';
                    } else {
                        elements.whatsappFlotIcon.style.display = 'none';
                    }
                } else {
                    console.warn("App Settings not found in database!");
                    appSettings = {};
                    elements.whatsappFlotIcon.style.display = 'none';
                }
            } catch (e) {
                console.error("Settings load failed", e);
                appSettings = {};
                elements.whatsappFlotIcon.style.display = 'none';
            }
        }
        
        function loadHomePageData() { if (!currentUser) { if(elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = ''; if(elements.gamesList) elements.gamesList.innerHTML = ''; if(elements.myContestsList) elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>'; return; } loadPromotions(); loadGames(); loadMyContests(); }
        async function loadPromotions() { if (!elements.promotionSlider) return; const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper'); if (!sliderWrapper) return; sliderWrapper.classList.add('placeholder-glow'); sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`; const promoRef = ref(db, 'promotions'); try { const snapshot = await get(promoRef); const promotions = snapshot.val() || {}; const activePromotions = Object.values(promotions).filter(p => p.imageUrl); removePlaceholders(elements.promotionSlider); sliderWrapper.innerHTML = ''; if (activePromotions.length > 0) { elements.promotionSlider.style.display = 'block'; activePromotions.forEach(promo => { const slide = document.createElement('div'); slide.className = 'swiper-slide'; slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`; sliderWrapper.appendChild(slide); }); if (swiperInstance) swiperInstance.destroy(true, true); swiperInstance = new Swiper(elements.promotionSlider, { loop: activePromotions.length > 1, autoplay: { delay: 3500, disableOnInteraction: false }, pagination: { el: '.swiper-pagination', clickable: true }, slidesPerView: 1 }); } else { elements.promotionSlider.style.display = 'none'; } } catch (e) { console.error("Promo load failed:", e); removePlaceholders(elements.promotionSlider); sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>'; elements.promotionSlider.style.display = 'block'; } }
        async function loadGames() { if (!elements.gamesList) return; elements.gamesList.classList.add('placeholder-glow'); elements.gamesList.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`; const gamesRef = ref(db, 'games'); try { const snapshot = await get(gamesRef); const games = snapshot.val() || {}; const activeGames = Object.entries(games).filter(([, game]) => game.imageUrl && game.name).sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0)); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = ''; if (activeGames.length > 0) { if (!appSettings.games) appSettings.games = {}; activeGames.forEach(([gameId, game]) => { appSettings.games[gameId] = { name: game.name }; const col = document.createElement('div'); col.className = 'col-6'; col.innerHTML = `<div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`; col.querySelector('.game-card').addEventListener('click', () => { currentTournamentGameId = gameId; loadTournamentsForGame(gameId, game.name); }); elements.gamesList.appendChild(col); }); } else { elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>'; } } catch (e) { console.error("Games load failed:", e); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>'; } }
        function loadTournamentsForGame(gameId, gameName) { if (!elements.tournamentsSection) return; currentTournamentGameId = gameId; elements.tournamentTabs.forEach(t => t.classList.remove('active')); querySel('#tournaments-section .tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active'); showSection('tournaments-section'); }
        async function filterTournaments(gameId, status) { if (!elements.tournamentsListContainer) return; elements.tournamentsListContainer.innerHTML = ''; elements.tournamentsListContainer.classList.add('placeholder-glow'); elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`; elements.noTournamentsMessage.style.display = 'none'; try { const tournamentsRef = ref(db, 'tournaments'); const s = await get(query(tournamentsRef, orderByChild('gameId'), equalTo(gameId))); const allT = s.val() || {}; const fT = Object.entries(allT).filter(([, t]) => { if (status === 'completed') { return t.status === 'completed' || t.status === 'result'; } return t.status === status; }).sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0)); removePlaceholders(elements.tournamentsListContainer); elements.tournamentsListContainer.innerHTML = ''; if (fT.length > 0) { fT.forEach(([tId, t]) => { const card = createTournamentCardElement(tId, t); elements.tournamentsListContainer.appendChild(card); }); } else { elements.noTournamentsMessage.style.display = 'block'; elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`; } } catch (e) { console.error(`Tournaments filter failed (${status}): `, e); removePlaceholders(elements.tournamentsListContainer); elements.tournamentsListContainer.innerHTML = '<p class="text-danger text-center mt-4">Could not load tournaments. Please check Firebase Rules for index on `gameId`.</p>'; elements.noTournamentsMessage.style.display = 'none'; } }
        async function loadMyContests() { if (!currentUser || !elements.myContestsList) { if(elements.myContestsList) removePlaceholders(elements.myContestsList); if(elements.myContestsList) elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; } const joinedIds = Object.keys(userProfile.joinedTournaments || {}); elements.myContestsList.classList.add('placeholder-glow'); elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none'; if (joinedIds.length === 0) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; } try { const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`))); const snapshots = await Promise.all(contestPromises); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; const contestCards = []; snapshots.forEach((snapshot, index) => { if (snapshot.exists()) { const t = snapshot.val(); if (t.status === 'upcoming' || t.status === 'ongoing') { const tId = joinedIds[index]; contestCards.push({ startTime: t.startTime || 0, card: createTournamentCardElement(tId, t) }); } } }); contestCards.sort((a, b) => a.startTime - b.startTime); if (contestCards.length > 0) { contestCards.forEach(item => elements.myContestsList.appendChild(item.card)); } else if (elements.noContestsMessage) { elements.noContestsMessage.style.display = 'block'; elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests."; } } catch (e) { console.error("My contests load failed:", e); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>'; } }
        function loadWalletData() { if (!currentUser) return; loadRecentTransactions(); }
        function loadProfileData() { if (!currentUser) return; if (userProfile?.displayName) { removePlaceholders(elements.profileName?.closest('.placeholder-glow')); removePlaceholders(elements.profileEmail?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileWonMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalEarnings?.closest('.placeholder-glow')); } }
        function loadEarningsData() { if (!currentUser) return; alert('This page is under construction.'); showSection('home-section');}
        async function recordTransaction(userId, type, amount, description, details = {}) { if (!userId) return; const transactionRef = ref(db, `transactions/${userId}`); const newTransaction = { type, amount, description, timestamp: Date.now(), ...details }; try { await push(transactionRef, newTransaction); } catch (e) { console.error("Transaction record failed:", e); } }
        async function loadRecentTransactions() { if (!currentUser || !elements.recentTransactionsList) return; const limit = 5; elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow'); for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>`; if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; } try { const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit)); const s = await get(transRef); const transactions = s.val() || {}; const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = ''; if (sortedT.length > 0) { if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; sortedT.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'; item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type || 'Txn'}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.recentTransactionsList.appendChild(item); }); } else if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'No recent transactions.'; } } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; } }
        
        // --- Remaining functions ---
        
        function createTournamentCardElement(tId, t) { const card = document.createElement('div'); card.className = 'tournament-card'; card.dataset.tournamentId = tId; const sTime = t.startTime ? new Date(t.startTime) : null; const sTimeLoc = sTime ? sTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA'; let timerTxt = t.status?.toUpperCase() || 'N/A'; if (t.status === 'upcoming' && sTime) { timerTxt = getTimeRemaining(t.startTime); } else if (t.status === 'ongoing') { timerTxt = 'LIVE'; } else if (t.status === 'completed' || t.status === 'result') { timerTxt = 'ENDED'; } const maxP = t.maxPlayers || 0; const regC = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0; const spotsL = maxP > 0 ? Math.max(0, maxP - regC) : Infinity; let spotsTxt = 'Unlimited Spots'; let progP = 0; if (maxP > 0) { spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Spots Left (${regC}/${maxP})`; progP = Math.min(100, (regC / maxP) * 100); } let actionButtonsHTML = ''; let idPassBtn = ''; const isJ = currentUser && userProfile?.joinedTournaments?.[tId]; if (t.status === 'completed' || t.status === 'result') { actionButtonsHTML = `<button class="btn btn-custom btn-custom-accent btn-sm w-100 btn-view-results" style="grid-column: 1 / -1;" data-tournament-id="${tId}"><i class="bi bi-trophy-fill"></i> View Results</button>`; } else { const detailsBtnHTML = `<button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}">Details</button>`; let joinBtnHTML = ''; if (isJ) { joinBtnHTML = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`; if (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && sTime && Date.now() > sTime.getTime() - 900000)) { idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`; } } else if (t.status === 'upcoming' && !(maxP > 0 && spotsL <= 0)) { joinBtnHTML = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${t.entryFee || 0}">${t.entryFee || 0} Join <i class="bi bi-arrow-right-short"></i></button>`; } else { const reason = (t.status?.toUpperCase() === 'UPCOMING' && maxP > 0 && spotsL <= 0) ? 'FULL' : t.status?.toUpperCase(); joinBtnHTML = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${reason || 'N/A'}</button>`; } actionButtonsHTML = `${detailsBtnHTML}${joinBtnHTML}`; } card.innerHTML = `<div class="tournament-card-header"><div class="tournament-card-tags">${t.mode ? `<span>${t.mode}</span>` : ''}${t.map ? `<span>${t.map}</span>` : ''}</div><div class="tournament-card-timer">${timerTxt}</div></div><h3 class="tournament-card-title">${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} ${t.name || 'Tournament'}</h3><p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p><div class="tournament-card-info"><div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ${t.prizePool || 0}</strong></div><div class="info-item"><span>Per Kill</span><strong>${t.perKillPrize || 0}</strong></div><div class="info-item"><span>Entry Fee</span><strong class="${(t.entryFee || 0) > 0 ? 'text-info' : ''}">${(t.entryFee || 0) > 0 ? `${t.entryFee}` : 'Free'}</strong></div></div><div class="tournament-card-spots">${spotsTxt}${maxP > 0 ? `<div class="progress mt-1"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}</div><div class="tournament-card-actions">${actionButtonsHTML}</div>${idPassBtn}`; card.querySelector('.btn-join')?.addEventListener('click', handleJoinTournamentClick); card.querySelector('.btn-details')?.addEventListener('click', handleMatchDetailsClick); card.querySelector('.btn-idpass')?.addEventListener('click', handleIdPasswordClick); card.querySelector('.btn-view-results')?.addEventListener('click', handleViewResultsClick); return card; }
        async function handleJoinTournamentClick(event) { if (!currentUser) { alert("Login to join."); showSection('login-section'); return; } const btn = event.currentTarget; const tId = btn.dataset.tournamentId; const fee = parseFloat(btn.dataset.fee || 0); if (!tId || !elements.gameIdModalInstance) return; const tournamentRef = ref(db, `tournaments/${tId}`); try { const snapshot = await get(tournamentRef); if (!snapshot.exists()) { alert("Tournament not found."); return; } const tournamentData = snapshot.val(); elements.gameIdModalTournamentName.textContent = tournamentData.name || 'Tournament'; elements.gameIdModalEntryFee.textContent = `${fee.toFixed(2)}`; const gameProfile = userProfile?.gameProfiles?.[tournamentData.gameId]; if(gameProfile) { elements.gameUsernameInput.value = gameProfile.username || ''; elements.gameUidInput.value = gameProfile.uid || ''; } else { elements.gameUsernameInput.value = ''; elements.gameUidInput.value = ''; } elements.confirmJoinBtn.dataset.tournamentId = tId; elements.confirmJoinBtn.dataset.fee = fee; clearStatusMessage(elements.gameIdStatusMessage); elements.gameIdModalInstance.show(); } catch (error) { console.error("Error preparing to join tournament:", error); alert("Could not open join dialog. Please try again."); } }
        async function confirmAndJoinTournament() { if (!currentUser) return; const btn = elements.confirmJoinBtn; const tId = btn.dataset.tournamentId; const fee = parseFloat(btn.dataset.fee || 0); const gameUsername = elements.gameUsernameInput.value.trim(); const gameUid = elements.gameUidInput.value.trim(); if (!tId) { showStatusMessage(elements.gameIdStatusMessage, 'Tournament ID missing. Please close and try again.', 'danger'); return; } if (!gameUsername || !gameUid) { showStatusMessage(elements.gameIdStatusMessage, 'Please fill in both your In-Game Name and UID.', 'warning'); return; } btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...'; clearStatusMessage(elements.gameIdStatusMessage); const uRef = ref(db, `users/${currentUser.uid}`); const tRef = ref(db, `tournaments/${tId}`); let tData = null; let transactionResult = null; try { tData = (await get(tRef)).val(); if(!tData) throw new Error("Tournament not found."); const gameIdForProfile = tData.gameId; transactionResult = await runTransaction(uRef, (profileData) => { if (!profileData) return; if (profileData.joinedTournaments?.[tId]) return; const totalAvailable = (profileData.bonusCash || 0) + (profileData.winningCash || 0); if (totalAvailable < fee) return; let feeToPay = fee; let paidFromBonus = 0; let paidFromWinnings = 0; const fromBonus = Math.min(feeToPay, (profileData.bonusCash || 0)); profileData.bonusCash -= fromBonus; paidFromBonus = fromBonus; feeToPay -= fromBonus; if (feeToPay > 0) { const fromWinnings = Math.min(feeToPay, (profileData.winningCash || 0)); profileData.winningCash -= fromWinnings; paidFromWinnings = fromWinnings; } if (!profileData.joinedTournaments) profileData.joinedTournaments = {}; profileData.joinedTournaments[tId] = { paidFromBonus, paidFromWinnings, joinedAt: serverTimestamp() }; if (!profileData.gameProfiles) profileData.gameProfiles = {}; profileData.gameProfiles[gameIdForProfile] = { username: gameUsername, uid: gameUid, lastUpdated: serverTimestamp() }; return profileData; }); if (!transactionResult.committed) { const latestProfile = (await get(uRef)).val(); if (latestProfile?.joinedTournaments?.[tId]) throw new Error("Already joined this tournament."); throw new Error("Insufficient balance. Fee is deducted from Bonus and then Winning cash."); } const updates = {}; updates[`tournaments/${tId}/registeredPlayers/${currentUser.uid}`] = { joinedAt: serverTimestamp(), gameUsername, gameUid }; await update(ref(db), updates); const joinDetails = transactionResult.snapshot.val().joinedTournaments[tId]; await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined: ${tData.name || 'Tournament'}`, { tournamentId: tId, deductedFromBonus: joinDetails.paidFromBonus, deductedFromWinnings: joinDetails.paidFromWinnings }); alert(`Successfully joined! ${fee.toFixed(2)} deducted.`); elements.gameIdModalInstance.hide(); if (currentSectionId === 'tournaments-section' && currentTournamentGameId) filterTournaments(currentTournamentGameId, 'upcoming'); if (currentSectionId === 'home-section') loadMyContests(); } catch (e) { console.error("Join failed:", e); showStatusMessage(elements.gameIdStatusMessage, `Join Failed: ${e.message}`, 'danger'); if (transactionResult && transactionResult.committed) { const joinDetails = transactionResult.snapshot.val().joinedTournaments[tId]; try { await runTransaction(uRef, (profileData) => { if (profileData) { profileData.bonusCash = (profileData.bonusCash || 0) + (joinDetails.paidFromBonus || 0); profileData.winningCash = (profileData.winningCash || 0) + (joinDetails.paidFromWinnings || 0); if (profileData.joinedTournaments?.[tId]) delete profileData.joinedTournaments[tId]; } return profileData; }); await recordTransaction(currentUser.uid, 'join_failed_refund', fee, `Refund for Failed Join: ${tData?.name || 'Tournament'}`); showStatusMessage(elements.gameIdStatusMessage, `Join Failed: ${e.message}. Your balance has been refunded.`, 'danger', false); } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError); showStatusMessage(elements.gameIdStatusMessage, `Join failed. CRITICAL: Failed to auto-refund your balance (${fee.toFixed(2)}). Please contact support immediately.`, 'danger', false); } } } finally { btn.disabled = false; btn.innerHTML = 'Confirm & Join'; } }
        const challengeRulesMap = { 'Ludo King Classic': 'Room code share karke game khelein. Jeetne ka screenshot lein. Goti safe zone me rakhne par jeet maani jaayegi.', 'Snake & Ladders': 'Room code share karke game khelein. Jeetne ka screenshot lein. Jo pehle 100 tak pahuchega, woh jeetega.', 'FF Lone Wolf': 'Room code share karke game khelein. Jeetne ka screenshot lein. 4 round jeetne wala winner hoga.', 'FF Clash Squad': 'Room code share karke game khelein. Jeetne ka screenshot lein. 7 round jeetne wala winner hoga.' };
        async function loadChallenges(filter) { if (!currentUser || !elements.challengesListContainer) return; elements.challengesListContainer.innerHTML = ''; elements.challengesListContainer.classList.add('placeholder-glow'); elements.challengesListContainer.innerHTML = `<div class="challenge-card placeholder-glow mb-3"><span class="placeholder col-12" style="height: 40px;"></span><span class="placeholder col-10 mt-2" style="height: 24px;"></span><span class="placeholder col-4 ms-auto mt-2" style="height: 30px;"></span></div>`; elements.noChallengesMessage.style.display = 'none'; try { const challengesRef = query(ref(db, 'challenges')); const snapshot = await get(challengesRef); const allChallenges = snapshot.val() || {}; let filteredChallenges = []; if (filter === 'open') { filteredChallenges = Object.entries(allChallenges).filter(([, c]) => c.status === 'open' && c.creatorUid !== currentUser.uid); } else { filteredChallenges = Object.entries(allChallenges).filter(([, c]) => c.creatorUid === currentUser.uid || c.opponentUid === currentUser.uid); } filteredChallenges.sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0)); removePlaceholders(elements.challengesListContainer); elements.challengesListContainer.innerHTML = ''; if (filteredChallenges.length > 0) { for (const [id, challenge] of filteredChallenges) { const card = await createChallengeCardElement(id, challenge); elements.challengesListContainer.appendChild(card); } } else { elements.noChallengesMessage.style.display = 'block'; elements.noChallengesMessage.textContent = `No ${filter} challenges found.`; } } catch (e) { console.error(`Challenges load failed (${filter}):`, e); removePlaceholders(elements.challengesListContainer); elements.challengesListContainer.innerHTML = '<p class="text-danger text-center mt-4">Could not load challenges.</p>'; elements.noChallengesMessage.style.display = 'none'; } }
        async function createChallengeCardElement(id, data) { const card = document.createElement('div'); card.className = 'challenge-card'; card.dataset.challengeId = id; const creatorAvatar = data.creatorAvatar || getAvatar({displayName: data.creatorName}); let actionBtnHTML = ''; if (data.status === 'open' && data.creatorUid !== currentUser?.uid) { actionBtnHTML = `<button class="btn btn-custom btn-custom-accent btn-sm btn-accept-challenge" data-challenge-id="${id}" data-stake="${data.stake}">Accept</button>`; } else { actionBtnHTML = `<button class="btn btn-custom btn-custom-secondary btn-sm btn-view-challenge" data-challenge-id="${id}">View</button>`; } card.innerHTML = ` <div class="challenge-card-header"> <div class="player-info"><img src="${creatorAvatar}" alt="player" class="player-avatar"><span class="player-name">${data.creatorName || 'Creator'}</span></div> <div class="challenge-card-stake">${data.stake || 0}</div> </div> <div class="challenge-card-body"> <span class="game-name"><i class="bi bi-joystick"></i> ${data.gameMode || 'Custom Game'}</span> <span class="challenge-card-status status-${data.status}">${data.status}</span> </div> <div class="challenge-card-actions">${actionBtnHTML}</div>`; card.querySelector('.btn-accept-challenge')?.addEventListener('click', handleAcceptChallengeClick); card.querySelector('.btn-view-challenge')?.addEventListener('click', handleViewChallengeClick); return card; }
        async function handleSubmitChallenge() { if(!currentUser) return; const gameMode = elements.challengeGameModeSelect.value; const amount = parseFloat(elements.challengeAmountInput.value); const customRules = elements.challengeCustomRulesInput.value.trim(); if (!gameMode) { showStatusMessage(elements.createChallengeStatusMessage, 'Please select a game mode.', 'warning'); return; } if (isNaN(amount) || amount < (appSettings.minChallengeStake || 10)) { showStatusMessage(elements.createChallengeStatusMessage, `Minimum challenge amount is ${appSettings.minChallengeStake || 10}.`, 'warning'); return; } const totalBalance = (userProfile.winningCash || 0) + (userProfile.bonusCash || 0); if(totalBalance < amount) { showStatusMessage(elements.createChallengeStatusMessage, 'Insufficient balance.', 'danger'); return; } const btn = elements.submitChallengeBtn; btn.disabled = true; btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Creating...`; const uRef = ref(db, `users/${currentUser.uid}`); runTransaction(uRef, (profile) => { if(profile) { const totalAvailable = (profile.bonusCash || 0) + (profile.winningCash || 0); if(totalAvailable < amount) return; let feeToPay = amount, paidFromBonus = 0, paidFromWinnings = 0; const fromBonus = Math.min(feeToPay, (profile.bonusCash || 0)); profile.bonusCash -= fromBonus; paidFromBonus = fromBonus; feeToPay -= fromBonus; if(feeToPay > 0) { const fromWinnings = Math.min(feeToPay, (profile.winningCash || 0)); profile.winningCash -= fromWinnings; paidFromWinnings = fromWinnings; } } return profile; }).then(async (result) => { if(!result.committed) throw new Error("Could not deduct balance. Please try again."); const challengeData = { creatorUid: currentUser.uid, creatorName: userProfile.displayName, creatorAvatar: getAvatar(userProfile), gameMode: gameMode, stake: amount, status: 'open', createdAt: serverTimestamp(), ...(customRules && { customRules: customRules }) }; await push(ref(db, 'challenges'), challengeData); await recordTransaction(currentUser.uid, 'challenge_created', -amount, `Challenge Created for ${amount}`); elements.createChallengeModalInstance.hide(); alert('Challenge created successfully!'); const activeFilter = querySel('#challenges-section .tournament-tabs .tab-item.active')?.dataset.filter || 'open'; loadChallenges(activeFilter); }).catch(err => { showStatusMessage(elements.createChallengeStatusMessage, `Error: ${err.message}`, 'danger'); }).finally(() => { btn.disabled = false; btn.innerHTML = 'Create Challenge'; }); }
        async function handleAcceptChallengeClick(event) { if(!currentUser) return; const btn = event.currentTarget; const challengeId = btn.dataset.challengeId; const stake = parseFloat(btn.dataset.stake); if(!challengeId || isNaN(stake) || !confirm(`Accept this challenge for ${stake}? This amount will be deducted from your wallet.`)) return; showLoader(true); const uRef = ref(db, `users/${currentUser.uid}`); const cRef = ref(db, `challenges/${challengeId}`); try { const cSnap = await get(cRef); const cData = cSnap.val(); if(!cSnap.exists() || cData.status !== 'open') throw new Error("Challenge is no longer available."); if(cData.creatorUid === currentUser.uid) throw new Error("You cannot accept your own challenge."); const txResult = await runTransaction(uRef, (profile) => { if(profile) { const totalAvailable = (profile.bonusCash || 0) + (profile.winningCash || 0); if(totalAvailable < stake) return; let feeToPay = stake; const fromBonus = Math.min(feeToPay, (profile.bonusCash || 0)); profile.bonusCash -= fromBonus; feeToPay -= fromBonus; if (feeToPay > 0) { const fromWinnings = Math.min(feeToPay, (profile.winningCash || 0)); profile.winningCash -= fromWinnings; } return profile; } return profile; }); if(!txResult.committed) throw new Error("Insufficient balance to accept."); await update(cRef, { status: 'active', opponentUid: currentUser.uid, opponentName: userProfile.displayName, opponentAvatar: getAvatar(userProfile) }); await recordTransaction(currentUser.uid, 'challenge_accepted', -stake, `Challenge Accepted for ${stake}`); alert(`Challenge accepted! You can now view it in "My Challenges".`); 
            // [MODIFICATION] - Send notification to creator
            await sendNotificationToUser(cData.creatorUid, 'Challenge Accepted!', `${userProfile.displayName || 'A player'} has accepted your challenge for ${stake}.`);
        querySelAll('#challenges-section .tab-item').forEach(t => t.classList.remove('active')); const myChallengesTab = querySel('#challenges-section .tab-item[data-filter="my"]'); if (myChallengesTab) { myChallengesTab.classList.add('active'); loadChallenges('my'); } } catch(err) { alert(`Failed to accept challenge: ${err.message}`); } finally { showLoader(false); } }
        async function handleViewChallengeClick(event) { if(!currentUser) return; const challengeId = event.currentTarget.dataset.challengeId; if(!challengeId) return; elements.viewChallengeModalTitle.textContent = "Loading Challenge..."; elements.viewChallengeModalBody.innerHTML = `<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>`; elements.viewChallengeModalInstance.show(); const cRef = ref(db, `challenges/${challengeId}`); const cSnap = await get(cRef); if(!cSnap.exists()) { elements.viewChallengeModalBody.innerHTML = `<p class="text-danger">Could not find this challenge.</p>`; return; } const data = cSnap.val(); const isCreator = data.creatorUid === currentUser.uid; const isOpponent = data.opponentUid === currentUser.uid; elements.viewChallengeModalTitle.textContent = `Challenge: ${data.gameMode}`; const commission = appSettings.challengeCommission || 0.05; const prizePot = data.stake * 2; const finalPrize = prizePot * (1 - commission); let bodyHTML = ` <div class="d-flex justify-content-around align-items-center text-center my-3"> <div><img src="${data.creatorAvatar || getAvatar({displayName: data.creatorName})}" class="profile-avatar mb-2" style="width:50px; height:50px;"><p class="mb-0 small">${data.creatorName}</p></div> <div class="vs-icon">VS</div> <div>${data.opponentUid ? `<img src="${data.opponentAvatar || getAvatar({displayName: data.opponentName})}" class="profile-avatar mb-2" style="width:50px; height:50px;"><p class="mb-0 small">${data.opponentName}</p>` : `<i class="bi bi-question-circle-fill display-4 text-secondary"></i><p class="mb-0 small">Open</p>`}</div> </div> <hr style="border-color: var(--border-color);"> <p><strong>Challenge Amount:</strong> ${data.stake}</p> <p><strong>Total Prize:</strong> ${finalPrize.toFixed(2)} <span class="small text-secondary"></span></p> <p><strong>Status:</strong> <span class="challenge-card-status status-${data.status}">${data.status}</span></p>`; const defaultRules = challengeRulesMap[data.gameMode]; if (defaultRules || data.customRules) { bodyHTML += `<div class="custom-card p-3 my-3" style="background-color: var(--primary-bg); font-size: 0.9rem;">`
        if(defaultRules) bodyHTML += `<p class="mb-2"><strong>Game Rules:</strong> ${defaultRules}</p>`; if(data.customRules) bodyHTML += `<p class="mb-0"><strong>Custom Rules:</strong> ${data.customRules}</p>`; bodyHTML += `</div>`; } if(data.status === 'active' && (isCreator || isOpponent)) { if (isCreator) { bodyHTML += `<div class="custom-card p-3"> <p class="small text-secondary">Share these details with your opponent. Only you can update them.</p> <div class="mb-3"><label class="form-label small">Room Code</label><input type="text" class="form-control" id="challengeRoomCodeInput" placeholder="Enter Room Code" value="${data.roomCode || ''}"></div> <div class="mb-3"><label class="form-label small">Password (Optional)</label><input type="text" class="form-control" id="challengePasswordInput" placeholder="Enter Optional Password" value="${data.roomPassword || ''}"></div> <button class="btn btn-sm btn-custom-secondary w-100" id="updateRoomDetailsBtn">Update Details</button> </div>`; } else { bodyHTML += `<hr><p class="small text-secondary">The creator will provide the room details. Waiting for update...</p>`; if(data.roomCode) bodyHTML += `<p><strong>Room Code:</strong> ${data.roomCode}</p>`; if(data.roomPassword) bodyHTML += `<p><strong>Password:</strong> ${data.roomPassword}</p>`; } if(!data.roomCode) { bodyHTML += `<button class="btn btn-sm btn-outline-danger w-100 mt-3" id="cancelChallengeBtn">Cancel Challenge (Refund)</button>`; } else { bodyHTML += `<div class="mt-4 text-center"> <h5 class="section-title">Report Result</h5> <p class="small text-secondary mt-1">Dishonest reports may lead to a ban.</p> <div class="d-grid gap-2 mt-3 challenge-result-form"> <button class="btn btn-custom btn-success" data-report-type="win"><i class="bi bi-trophy-fill"></i> I Won (Upload Proof)</button> <button class="btn btn-custom btn-danger" data-report-type="loss"><i class="bi bi-emoji-frown-fill"></i> I Lost</button> <button class="btn btn-custom btn-warning text-dark" data-report-type="error"><i class="bi bi-exclamation-triangle-fill"></i> Report an Issue</button> </div> </div>`; } } else if (data.status === 'completed') { const winnerName = data.winnerUid === data.creatorUid ? data.creatorName : data.opponentName; const loserName = data.winnerUid === data.creatorUid ? data.opponentName : data.creatorName; const didIWin = data.winnerUid === currentUser.uid; const didILose = (isOpponent || isCreator) && data.winnerUid !== currentUser.uid; if (didIWin) { bodyHTML += `<hr><h4 class="text-center text-success"><i class="bi bi-trophy-fill"></i> You Won!</h4><p class="text-center small text-secondary">You defeated ${loserName}.</p>`; } else if (didILose) { bodyHTML += `<hr><h4 class="text-center text-danger"><i class="bi bi-emoji-frown-fill"></i> You Lose.</h4><p class="text-center small text-secondary">You were defeated by ${winnerName}.</p>`; } else { bodyHTML += `<hr><h4 class="text-center text-accent">Winner: ${winnerName}</h4>`; } } else if (data.status === 'disputed') { bodyHTML += `<hr><p class="text-center text-danger"><i class="bi bi-exclamation-triangle-fill"></i> This match is disputed. An admin will review it shortly.</p>`; } elements.viewChallengeModalBody.innerHTML = bodyHTML; querySel('#updateRoomDetailsBtn')?.addEventListener('click', () => { const newCode = querySel('#challengeRoomCodeInput').value.trim(); const newPass = querySel('#challengePasswordInput').value.trim(); update(cRef, { roomCode: newCode, roomPassword: newPass }).then(() => { alert('Room details updated!'); 
            // [MODIFICATION] - Send notification to opponent
            sendNotificationToUser(data.opponentUid, "Room Details Updated!", `The room details for your match with ${data.creatorName} have been updated.`);
        handleViewChallengeClick({currentTarget: {dataset: {challengeId}}}); }); }); querySelAll('#viewChallengeModalBodyEl [data-report-type]').forEach(btn => { btn.addEventListener('click', (e) => { const reportType = e.currentTarget.dataset.reportType; if(reportType === 'loss') { handleReportResult(challengeId, 'lost'); } else { openReportModal(challengeId, reportType); } }); }); querySel('#cancelChallengeBtn')?.addEventListener('click', () => handleCancelChallenge(challengeId, data)); }
        function openReportModal(challengeId, reportType) { elements.reportResultModalInstance.show(); elements.reportResultForm.reset(); clearStatusMessage(elements.reportResultStatusMessage); elements.reportImagePreview.style.display = 'none'; elements.reportImagePreview.src = ''; elements.reportChallengeIdInput.value = challengeId; elements.reportTypeInput.value = reportType; if(reportType === 'win') { elements.reportResultModalTitle.textContent = 'Report Your Win'; elements.reportScreenshotContainer.style.display = 'block'; elements.reportScreenshotInput.required = true; elements.reportMessageContainer.style.display = 'none'; elements.reportMessageInput.required = false; } else if (reportType === 'error') { elements.reportResultModalTitle.textContent = 'Report an Issue'; elements.reportScreenshotContainer.style.display = 'block'; elements.reportScreenshotInput.required = true; elements.reportMessageContainer.style.display = 'block'; elements.reportMessageInput.required = true; } }
        async function submitReportHandler() { const btn = elements.submitReportBtn; btn.disabled = true; btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Submitting...`; clearStatusMessage(elements.reportResultStatusMessage); const challengeId = elements.reportChallengeIdInput.value; const reportType = elements.reportTypeInput.value; const screenshotFile = elements.reportScreenshotInput.files[0]; const message = elements.reportMessageInput.value.trim(); try { if (!challengeId || !reportType) throw new Error("Missing report data."); if ((reportType === 'win' || reportType === 'error') && !screenshotFile) { throw new Error("Screenshot proof is required."); } if (reportType === 'error' && !message) { throw new Error("A message is required when reporting an issue."); } let imageUrl = null; if (screenshotFile) { showStatusMessage(elements.reportResultStatusMessage, 'Uploading image...', 'info', false); imageUrl = await uploadToImgBB(screenshotFile); } showStatusMessage(elements.reportResultStatusMessage, 'Saving report...', 'info', false); const cRef = ref(db, `challenges/${challengeId}`); if (reportType === 'error') { const disputeData = { reporterUid: currentUser.uid, message: message, screenshotUrl: imageUrl, reportedAt: serverTimestamp() }; await update(cRef, { status: 'disputed' }); await set(ref(db, `challenges/${challengeId}/disputes/${currentUser.uid}`), disputeData); alert('Your issue has been reported. An admin will review it shortly.'); } else { const reportData = { result: 'won', screenshotUrl: imageUrl, reportedAt: serverTimestamp() }; await update(ref(db, `challenges/${challengeId}/reports/${currentUser.uid}`), reportData); alert('Your result has been submitted. Waiting for the other player to report.'); await processChallengeResult(challengeId); } 
            // [MODIFICATION] - Send notification on any report
            const cSnap = await get(cRef);
            if (cSnap.exists()) {
                const cData = cSnap.val();
                const opponentUid = cData.creatorUid === currentUser.uid ? cData.opponentUid : cData.creatorUid;
                const notificationContent = reportType === 'win' ? `${userProfile.displayName} has reported their win.` : `${userProfile.displayName} has reported an issue with your match.`;
                sendNotificationToUser(opponentUid, "Match Update", notificationContent);
            }
        elements.reportResultModalInstance.hide(); handleViewChallengeClick({ currentTarget: { dataset: { challengeId } } }); } catch (err) { console.error('Report submission error:', err); showStatusMessage(elements.reportResultStatusMessage, `Error: ${err.message}`, 'danger'); } finally { btn.disabled = false; btn.innerHTML = 'Submit Report'; } }
        async function handleReportResult(challengeId, result) { if (!currentUser || (result === 'lost' && !confirm('Are you sure you want to report that you lost? This cannot be undone.'))) return; showLoader(true); try { await update(ref(db, `challenges/${challengeId}/reports/${currentUser.uid}`), { result: result, reportedAt: serverTimestamp() }); alert('Your result has been submitted. Waiting for the other player to report.'); 
            // [MODIFICATION] - Send notification
            const cSnap = await get(ref(db, `challenges/${challengeId}`));
            if (cSnap.exists()) {
                const cData = cSnap.val();
                const opponentUid = cData.creatorUid === currentUser.uid ? cData.opponentUid : cData.creatorUid;
                sendNotificationToUser(opponentUid, "Match Update", `${userProfile.displayName} has reported their loss.`);
            }
        await processChallengeResult(challengeId); handleViewChallengeClick({ currentTarget: { dataset: { challengeId } } }); } catch (e) { console.error("Result reporting error:", e); alert("Error submitting result. Please try again."); } finally { showLoader(false); } }
        async function processChallengeResult(challengeId) { const cRef = ref(db, `challenges/${challengeId}`); const cSnap = await get(cRef); const data = cSnap.val(); if (!data) return; const opponentUid = data.creatorUid === currentUser.uid ? data.opponentUid : data.creatorUid; const myReport = data.reports?.[currentUser.uid]?.result; const opponentReport = data.reports?.[opponentUid]?.result; if (myReport && opponentReport) { let winnerUid = null; if (myReport === 'won' && opponentReport === 'lost') winnerUid = currentUser.uid; else if (myReport === 'lost' && opponentReport === 'won') winnerUid = opponentUid; if (winnerUid) { const totalPot = data.stake * 2; const commissionRate = appSettings.challengeCommission || 0.05; const prize = totalPot * (1 - commissionRate); const loserUid = winnerUid === data.creatorUid ? data.opponentUid : data.creatorUid; await runTransaction(ref(db, `users/${winnerUid}`), (p) => { if(p) { p.winningCash = (p.winningCash || 0) + prize; p.totalEarnings = (p.totalEarnings || 0) + prize; p.wonMatches = (p.wonMatches || 0) + 1; p.totalMatches = (p.totalMatches || 0) + 1; } return p; }); await runTransaction(ref(db, `users/${loserUid}`), (p) => { if(p) p.totalMatches = (p.totalMatches || 0) + 1; return p; }); await update(cRef, { status: 'completed', winnerUid: winnerUid }); await recordTransaction(winnerUid, 'challenge_win', prize, `Won Challenge vs ${winnerUid === data.creatorUid ? data.opponentName : data.creatorName}`); alert(`Result confirmed! Prize of ${prize.toFixed(2)} awarded.`); elements.viewChallengeModalInstance.hide(); loadChallenges('my'); } else { await update(cRef, { status: 'disputed' }); alert('Result is disputed! An admin will review the match.'); elements.viewChallengeModalInstance.hide(); loadChallenges('my'); } } }
        async function handleCancelChallenge(challengeId, challengeData) { if (!currentUser || !confirm("Are you sure you want to cancel this challenge? The amount will be refunded to both players' bonus cash.")) return; showLoader(true); try { if(challengeData.roomCode) throw new Error("Cannot cancel a challenge after room details have been shared."); const creatorRef = ref(db, `users/${challengeData.creatorUid}`); const opponentRef = ref(db, `users/${challengeData.opponentUid}`); const stake = challengeData.stake; await runTransaction(creatorRef, (p) => { if(p) p.bonusCash = (p.bonusCash || 0) + stake; return p; }); await runTransaction(opponentRef, (p) => { if(p) p.bonusCash = (p.bonusCash || 0) + stake; return p; }); await recordTransaction(challengeData.creatorUid, 'challenge_refund', stake, `Refund for Cancelled Challenge`); await recordTransaction(challengeData.opponentUid, 'challenge_refund', stake, `Refund for Cancelled Challenge`); await remove(ref(db, `challenges/${challengeId}`)); alert("Challenge cancelled and amount refunded to both players."); elements.viewChallengeModalInstance.hide(); loadChallenges('my'); } catch(e) { console.error("Cancel challenge error:", e); alert(`Failed to cancel the challenge. ${e.message}`); } finally { showLoader(false); } }
        async function handleViewResultsClick(event) { if (!elements.matchDetailsModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return; elements.matchDetailsModalTitle.textContent = 'Loading Results...'; elements.matchDetailsModalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div></div>'; elements.matchDetailsModalInstance.show(); try { const tournamentRef = get(ref(db, `tournaments/${tId}`)); const resultsRef = get(ref(db, `results/${tId}`)); const [tournamentSnap, resultsSnap] = await Promise.all([tournamentRef, resultsRef]); if (resultsSnap.exists() && tournamentSnap.exists()) { const tournamentData = tournamentSnap.val(); const resultsData = resultsSnap.val(); elements.matchDetailsModalTitle.textContent = `Results: ${tournamentData.name || 'Tournament'}`; const playersArray = Object.values(resultsData); playersArray.sort((a, b) => (b.winnings || 0) - (a.winnings || 0) || (b.kills || 0) - (a.kills || 0)); let tableHTML = `<div class="table-responsive"><table class="results-table"><thead><tr><th class="rank">Rank</th><th>Player</th><th class="kills">Kills</th><th class="winnings">Winnings</th></tr></thead><tbody>`; if (playersArray.length > 0) { playersArray.forEach((player, index) => { const isCurrentUser = currentUser && player.uid === currentUser.uid; tableHTML += ` <tr class="${isCurrentUser ? 'current-user-row' : ''}"> <td class="rank">#${index + 1}</td> <td class="player-name">${player.displayName || 'Player'}</td> <td class="kills">${player.kills || 0}</td> <td class="winnings">${(player.winnings || 0).toFixed(2)}</td> </tr>`; }); } else { tableHTML += `<tr><td colspan="4" class="text-center text-secondary p-3">No player results found.</td></tr>`; } tableHTML += `</tbody></table></div>`; elements.matchDetailsModalBody.innerHTML = tableHTML; } else { elements.matchDetailsModalBody.innerHTML = '<p class="text-center text-secondary p-4">Results for this tournament have not been declared yet.</p>'; } } catch (e) { console.error("Error loading tournament results:", e); elements.matchDetailsModalBody.innerHTML = '<p class="text-center text-danger p-4">Could not load results. Please try again.</p>'; } }
        async function handleMatchDetailsClick(event) { if (!elements.matchDetailsModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return; elements.matchDetailsModalTitle.textContent = 'Loading...'; elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>'; elements.matchDetailsModalInstance.show(); try { const tRef = ref(db, `tournaments/${tId}`); const s = await get(tRef); if (s.exists()) { const t = s.val(); const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A'; const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short'}) : 'TBA'; let pDistHTML = ''; if (t.prizeDistribution) { let fmtDist = ''; if (typeof t.prizeDistribution === 'object') { fmtDist = Object.entries(t.prizeDistribution).map(([rank, prize]) => `Rank ${rank}: ${prize}`).join('\n'); } else { fmtDist = String(t.prizeDistribution).replace(/\\n/g, '\n'); } pDistHTML = `<h5>Prize Distribution:</h5><pre>${fmtDist}</pre>`; } const desc = t.description || 'Standard rules apply.'; const fmtDesc = desc.replace(/\n/g, '<br>'); elements.matchDetailsModalTitle.textContent = t.name || 'Match Details'; elements.matchDetailsModalBody.innerHTML = `<p><strong>Game:</strong> ${gName}</p><p><strong>Mode:</strong> ${t.mode || 'N/A'}</p><p><strong>Map:</strong> ${t.map || 'N/A'}</p><p><strong>Starts:</strong> ${sTimeLoc}</p><hr><p><strong>Entry:</strong> ${t.entryFee > 0 ? `${t.entryFee}` : 'Free'}</p><p><strong>Prize:</strong> ${t.prizePool || 0}</p><p><strong>Per Kill:</strong> ${t.perKillPrize || 0}</p><p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p><hr><h5>Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>${pDistHTML}`; } else elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>'; } catch (e) { console.error("Details load failed:", e); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; } }
        async function handleIdPasswordClick(event) { if (!elements.idPasswordModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return; if (!currentUser || !userProfile?.joinedTournaments?.[tId]) { alert("Join the tournament first or refresh the page."); return; } elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.idPasswordModalInstance.show(); try { const tournamentRef = ref(db, `tournaments/${tId}`); const s = await get(tournamentRef); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow')); if (s.exists()) { const tournamentData = s.val(); if (tournamentData.showIdPass) { elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet'; elements.roomPasswordDisplay.textContent = tournamentData.roomPassword || 'Not updated yet'; } else { elements.roomIdDisplay.textContent = 'Hidden by Admin'; elements.roomPasswordDisplay.textContent = 'Hidden by Admin'; } } else { elements.roomIdDisplay.textContent = 'Not Found'; elements.roomPasswordDisplay.textContent = 'Not Found'; } } catch (e) { console.error("ID/Pass fetch error:", e); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow')); elements.roomIdDisplay.textContent = 'Error'; elements.roomPasswordDisplay.textContent = 'Error'; alert("Error loading ID/Password. Check permissions or network."); } }
        async function handlePolicyClick(event) { if (!elements.policyModalInstance) return; event.preventDefault(); const policyType = event.currentTarget.dataset.policy; if (!policyType) return; let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>'; elements.policyModalBody.innerHTML = modalBodyContent; switch (policyType) { case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break; case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break; case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break; case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break; case 'refer': title = 'Refer & Earn'; if (!currentUser) { alert("Login to view referral."); return; } const refCode = userProfile.referralCode || 'N/A'; const refBonus = appSettings?.referralBonus || 0; const refDesc = appSettings?.referralDescription || `Get ${refBonus} when your friend joins using your code.`; modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${refDesc}</p></div>`; break; default: title = 'Info'; modalBodyContent = '<p>Content unavailable.</p>'; } elements.policyModalTitle.textContent = title; elements.policyModalBody.innerHTML = (typeof modalBodyContent === 'string' && policyType !== 'refer') ? modalBodyContent.replace(/\n/g, '<br>') : modalBodyContent; elements.policyModalInstance.show(); }
        async function submitAddMoneyRequest() { if (!currentUser) return; const amount = parseFloat(elements.addAmountInput.value); const transactionId = elements.transactionIdInput.value.trim(); if (isNaN(amount) || amount <= 0) { showStatusMessage(elements.addMoneyStatusMessage, 'Please enter a valid amount.', 'warning'); return; } if (!transactionId) { showStatusMessage(elements.addMoneyStatusMessage, 'Please enter the Transaction ID.', 'warning'); return; } showLoader(true); clearStatusMessage(elements.addMoneyStatusMessage); elements.submitAddMoneyRequestBtn.disabled = true; const requestData = { userId: currentUser.uid, userEmail: currentUser.email || 'N/A', displayName: userProfile.displayName || 'N/A', amount: amount, transactionId: transactionId, status: 'pending', requestTimestamp: serverTimestamp() }; try { const requestsRef = ref(db, 'addMoneyRequests'); await push(requestsRef, requestData); showLoader(false); showStatusMessage(elements.addMoneyStatusMessage, 'Request submitted! Amount will be credited after admin verification.', 'success', false); setTimeout(() => { elements.addAmountModalInstance.hide(); elements.submitAddMoneyRequestBtn.disabled = false; }, 3000); } catch (e) { console.error("Failed to submit add money request:", e); showLoader(false); showStatusMessage(elements.addMoneyStatusMessage, 'An error occurred. Please try again.', 'danger'); elements.submitAddMoneyRequestBtn.disabled = false; } }
        async function submitWithdrawRequestHandler() { if (!currentUser || !elements.withdrawModalInstance) return; const amt = parseFloat(elements.withdrawAmountInput.value); const mtd = elements.withdrawMethodInput.value.trim(); const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; clearStatusMessage(elements.withdrawStatusMessage); if (isNaN(amt) || amt <= 0) { showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning'); return; } if (amt < minW) { showStatusMessage(elements.withdrawStatusMessage, `Min withdraw ${minW}.`, 'warning'); return; } if (amt > wc) { showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning'); return; } if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; } elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...'; let transactionCommitted = false; try { const uRef = ref(db, `users/${currentUser.uid}`); const txResult = await runTransaction(uRef, (prof) => { if (prof) { if ((prof.winningCash || 0) >= amt) { prof.winningCash = (prof.winningCash || 0) - amt; return prof; } else { throw new Error("Insufficient winning balance (Tx)."); } } else { throw new Error("Profile missing (Tx)."); } }); if (!txResult.committed) { throw new Error("Failed to update balance. Please try again."); } transactionCommitted = true; const wrRef = ref(db, 'withdrawals'); const newReq = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amt, methodDetails: { methodName: mtd.includes('@') ? 'UPI' : 'Bank/Other', accountInfo: mtd }, status: 'pending', requestTimestamp: serverTimestamp(), userEmail: currentUser.email || 'N/A' }; const newWithdrawalRef = await push(wrRef, newReq); await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newWithdrawalRef.key }); showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false); setTimeout(() => { if (elements.withdrawModalInstance) elements.withdrawModalInstance.hide(); }, 2500); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } catch (e) { console.error("Withdraw error:", e); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger'); if (transactionCommitted) { const uRef = ref(db, `users/${currentUser.uid}`); try { await runTransaction(uRef, (prof) => { if (prof) { prof.winningCash = (prof.winningCash || 0) + amt; } return prof; }); await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal Request`); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger'); } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND WINNING CASH!", refundError); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. CRITICAL: Failed to refund amount! Contact support.`, 'danger', false); } } } finally { elements.submitWithdrawRequestBtn.disabled = false; elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request'; } }

        function setupRealtimeListeners(uid) { if (!uid || !db || !currentUser) return; detachAllDbListeners(); const uRef = ref(db, `users/${uid}`); const listFunc = onValue(uRef, (s) => { if (currentUser && currentUser.uid === uid) { if (s.exists()) { userProfile = s.val(); populateUserInfo(currentUser, userProfile); if (currentSectionId === 'home-section') loadMyContests(); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } else { logoutUser(); } } else { off(uRef, 'value', listFunc); } }, (e) => { console.error("Listener error (user profile):", e); }); dbListeners['userProfile'] = { path: `users/${uid}`, func: listFunc }; }
        function detachAllDbListeners() { for (const k in dbListeners) { try { const { path, func } = dbListeners[k]; if (path && func) { off(ref(db, path), 'value', func); } } catch (e) { console.error(`Detach error ${k}:`, e); } } dbListeners = {}; }
        function initializeEventListeners() { if (!elements) return; elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); })); elements.headerBackBtn?.addEventListener('click', () => showSection('home-section')); elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (currentTournamentGameId && s) { elements.tournamentTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); filterTournaments(currentTournamentGameId, s); } })); elements.loginEmailBtn?.addEventListener('click', loginWithEmail); elements.signupEmailBtn?.addEventListener('click', signUpWithEmail); elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false)); elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true)); elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); }); elements.logoutProfileBtn?.addEventListener('click', logoutUser); elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick)); 
            
            // [MODIFICATION] - OneSignal notification switch handler
            elements.notificationSwitch?.addEventListener('change', async (e) => {
                 if (window.OneSignal) {
                    if (e.target.checked) {
                        // This will trigger the native prompt
                        await window.OneSignal.showNativePrompt();
                    } else {
                        // This doesn't disable notifications but can be a placeholder for a custom UI
                        alert("To disable notifications, you need to manage them in your browser's site settings.");
                        e.target.checked = true; // Revert the switch as we can't disable from here
                    }
                }
            }); 
            
            elements.withdrawBtn?.addEventListener('click', () => elements.withdrawModalInstance.show()); 
            
            elements.addAmountWalletBtn?.addEventListener('click', () => {
                if (currentUser) {
                    if (appSettings.upiId) {
                        elements.upiIdDisplay.textContent = appSettings.upiId;
                        getElement('addMoneyRequestForm')?.reset();
                        clearStatusMessage(elements.addMoneyStatusMessage);
                        elements.addAmountModalInstance.show();
                    } else {
                        alert("The admin has not configured a UPI ID. Please try again later.");
                    }
                } else {
                    alert("Login first.");
                    showSection('login-section');
                }
            });
            
            elements.submitAddMoneyRequestBtn?.addEventListener('click', submitAddMoneyRequest); elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler); elements.notificationBtn?.addEventListener('click', () => alert('Notifications coming soon!')); elements.allTransactionsBtn?.addEventListener('click', () => alert('Transaction history page coming soon!')); elements.viewEarningsHistoryBtn?.addEventListener('click', () => alert('Earnings history coming soon!')); document.body.addEventListener('click', (event) => { if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) { const btn = event.target.closest('.copy-btn'); const targetSelector = btn.dataset.target; if (targetSelector) copyToClipboard(targetSelector); } if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) { const cel = getElement('referralCodeDisplay'); if (cel) shareReferral(cel.textContent); } }); elements.confirmJoinBtn?.addEventListener('click', confirmAndJoinTournament); elements.challengeTabs?.forEach(tab => tab.addEventListener('click', (e) => { const filter = e.currentTarget.dataset.filter; if (filter) { elements.challengeTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); loadChallenges(filter); } })); elements.createChallengeBtn?.addEventListener('click', async () => { if(!currentUser) { alert('Login to create a challenge.'); return; } const challengesRef = query(ref(db, 'challenges'), orderByChild('creatorUid'), equalTo(currentUser.uid)); const snapshot = await get(challengesRef); let hasActiveChallenge = false; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const challenge = childSnapshot.val(); if (challenge.status === 'open' || challenge.status === 'active') { hasActiveChallenge = true; } }); } if (hasActiveChallenge) { alert("You already have an active challenge. Please complete it before creating a new one."); return; } getElement('createChallengeForm')?.reset(); elements.challengeRules.style.display = 'none'; clearStatusMessage(elements.createChallengeStatusMessage); elements.createChallengeModalInstance.show(); }); elements.submitChallengeBtn?.addEventListener('click', handleSubmitChallenge); elements.challengeGameModeSelect?.addEventListener('change', (e) => { const gameMode = e.target.value; if (challengeRulesMap[gameMode]) { elements.challengeRules.innerHTML = `<strong>Rules:</strong> ${challengeRulesMap[gameMode]}`; elements.challengeRules.style.display = 'block'; } else { elements.challengeRules.style.display = 'none'; } }); elements.submitReportBtn?.addEventListener('click', submitReportHandler); elements.reportScreenshotInput?.addEventListener('change', (event) => { const file = event.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => { elements.reportImagePreview.src = e.target.result; elements.reportImagePreview.style.display = 'block'; }; reader.readAsDataURL(file); } });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (!db) return;
            showLoader(true);
            loadAppSettings()
                .then(() => {
                    initializeEventListeners();
                    updateGlobalUI(false); 
                    onAuthStateChanged(auth, handleAuthStateChange);
                })
                .catch(err => {
                    console.error("CRITICAL: Initial settings load failed:", err);
                    showLoader(false);
                });
        });
    </script>
</body>
</html>